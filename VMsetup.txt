SETTING UP A VM FOR A BACKEND
-----------------------------

1. Utilities and Git - install first

    sudo apt-get install -y xtitle vim exuberant-ctags git tcpdump supervisor
    sudo apt-get install -y python-pip unzip python-dev python-docutils

2. Django & Apache & MySQL

    sudo apt-get install -y python-imaging python-pythonmagick python-markdown
    sudo apt-get install -y python-textile python-django
    sudo apt-get install -y apache2 apache2-data apache2-mpm-prefork apache2-utils
    sudo apt-get install -y libapache2-mod-wsgi
    sudo apt-get install -y libmysqlclient-dev libexpat1 ssl-cert
    sudo apt-get install -y sqlite3 sqlite3-doc

    sudo pip install django
    sudo pip install MySQL-python
    sudo pip install httplib2

3. web.py, SQLAlchemy and sqlite3, pyparsing

    sudo apt-get install -y sqlite3 sqlite3-doc
    sudo pip install SQLAlchemy
    sudo pip install web.py
    sudo pip install pyparsing

4. Final cleanup

    sudo apt-get -y update && sudo apt-get -y upgrade && sudo apt-get -y dist-upgrade

5. ubuntu home directory

    Edit .bashrc:

        -- comment out PS1= stuff (2 places)
        -- add 'xtitle AWS-VCIOSERVER2'
        -- add aliases:
            alias rm='rm -i'
            alias gitshow='git show --pretty="format:" --name-only $1'
            alias update='sudo apt-get -y update && sudo apt-get -y upgrade'
            alias title=xtitle
        -- set the cdpath
            CDPATH=".:..:~:~/src:~/src/ld:~/src/ld/mgmtserver:~/src/ld/mgmtserver/server"
            -or-
            CDPATH=".:..:~:~/src:~/src/ld:~/src/ld/vcioserver:~/src/ld/vcioserver/site"
            -or-
            CDPATH=".:..:~:~/src:~/src/ld:~/src/ld/regserver:~/src/ld/regserver/server"

    Edit .vimrc:

        set tabstop=4 shiftwidth=4 softtabstop=4 expandtab
        set wrapscan wrapmargin=0 wrap linebreak textwidth=0 columns=96
        set backspace=indent,eol,start
        set autoindent nosmartindent cindent
        set ignorecase smartcase
        set hlsearch
        set noedcompatible nocompatible nocscopetag
        set exrc
        set tags=./tags,../tags,../../tags,../../../tags,~/tags
        set title

        inoremap # X^H#
        nnoremap ^] g^]

        syn on
        filetype plugin on
        filetype indent on

        let &titlestring = "AWS-VCIOSERVER2" . ": " . expand("%m%t")
        auto BufEnter * :let &titlestring = "AWS-VCIOSERVER2" . ": " . expand("%m%t")
        auto VimLeave * :set t_ts="AWS-VCIOSERVER2"

6. LD source tree

    mkdir -p /home/ubuntu/src
    cd /home/ubuntu/src
    git clone https://talex1962@github.com/talex1962/ld.git
    cd ld
    git push -u origin master
    git config --global user.name "Tom"
    git config --global user.email talex1962@gmail.com
    git config --global push.default matching

7. Permissions

    sudo vi /etc/group
    -- add ubuntu to adm, sudo, users, fuse, syslog, netdev, ssh
    sudo chgrp syslog /var/log
    sudo chmod ug+w /var/log

8. For regserver:

    -- create the supervisord config file
    sudo vi /etc/supervisor/conf.d/regserver.conf
        -- modify:
        [program:regserver]
        command=python -u regserver.py
        process_name=regserver
        directory=/usr/local/lib/ld/regserver/server
        stdout_logfile=/tmp/regConsole.log
        stdout_logfile_backups=1
        stdout_logfile_maxbytes=5MB
        redirect_stderr=true
        autostart=true
        autorestart=true
        startretries=1000
        user=ubuntu

    -- generate JSON DB
    -- NOTE: FIRST edit regTable.py to ensure that settings are correct
    cd /home/ubuntu/src/ld/regserver/server/db
    vi regTable.py
        -- modify:
            -- entryDict for each device
            -- write entryDict into JSON DB for each device
    python regTable.py
    -- now revert the DB-maker to prevent unnecessary Git updates
    git checkout -- regTable.py

    -- copy over the various regserver files to their various locations
    sudo mkdir /usr/local/lib/ld
    sudo cp -r /home/ubuntu/src/ld/libs /usr/local/lib/ld
    sudo cp -r /home/ubuntu/src/ld/regserver /usr/local/lib/ld
    sudo mkdir -p /var/lib/ld/db
    sudo chown -R ubuntu:ubuntu /var/lib/ld /var/lib/ld/db
    sudo cp /home/ubuntu/src/ld/regserver/server/db/regDB.json /var/lib/ld/db
    sudo chown -R ubuntu:ubuntu /var/lib/ld/db/*

    -- edit regServer.py in /usr/local, adapt to this instance:
    sudo vi /usr/local/lib/ld/regserver/server/regserver.py
        -- modify:
        regDBFile = '/var/lib/ld/db/regDB.db'
        LOG_LEVEL = 'INFO'
        LOG_FILE = '/var/log/regserver.log'

        configureLogging(logfile=LOG_FILE, fileLevel=LOG_LEVEL, consoleLevel='WARNING')

    -- start off the regserver daemon
    sudo supervisorctl
        supervisor> reread
        supervisor> update
        supervisor> status
        supervisor> exit

9. For mgmtserver:

    -- download and build SoftEther VPN server
    cd /tmp
    wget http://www.softether-download.com/files/softether/v4.11-9506-beta-2014.10.22-tree/Linux/SoftEther_VPN_Server/64bit_-_Intel_x64_or_AMD64/softether-vpnserver-v4.11-9506-beta-2014.10.22-linux-x64-64bit.tar.gz
    sudo apt-get install -y build-essential
    sudo tar zxvf /tmp/softether-vpnserver-v4.11-9506-beta-2014.10.22-linux-x64-64bit.tar.gz -C /usr/local
    cd /usr/local/vpnserver
    sudo make
        -- type '1' to indicate reading the License Agreement, '1' to indicate agreement,
            '1' to continue
    sudo chmod -R 600 *
    sudo chmod 700 vpnserver vpncmd
    cd ..
    sudo chmod 700 vpnserver
    sudo /usr/local/vpnserver/vpncmd /TOOLS /CMD check

    -- create the supervisord config file
    sudo vi /etc/supervisor/conf.d/mgmtserver.conf
        -- modify:
        [program:mgmtserver]
        command=python -u mgmtAPIServer.py
        process_name=mgmtserver
        directory=/usr/local/lib/ld/mgmtserver/server
        stdout_logfile=/tmp/mgmtConsole.log
        stdout_logfile_backups=1
        stdout_logfile_maxbytes=5MB
        redirect_stderr=true
        autostart=true
        autorestart=true
        startretries=1000
        user=ubuntu

    -- copy over the various mgmtserver files to their various locations
    sudo mkdir -p /usr/local/lib/ld
    sudo mkdir -p /var/lib/ld/db
    sudo cp -r /home/ubuntu/src/ld/libs /usr/local/lib/ld
    sudo cp -r /home/ubuntu/src/ld/mgmtserver /usr/local/lib/ld

    -- copy over the master configuration file and edit to match site needs:
    sudo rm -f /usr/local/lib/ld/mgmtserver/server/mgmtConfig.ini
    sudo cp /home/ubuntu/src/ld/mgmtserver/server/mgmtConfig.ini /usr/local/etc
    sudo vi /usr/local/etc/mgmtConfig.ini
        -- modify as follows (leave rest unchanged):
        [DEFAULT]
        DBPath = /var/lib/ld/db
        logPath = /var/log

        [MAIN]
        fileLogLevel = INFO
        consoleLogLevel = WARNING
        defaultSites = yes

        [MGMTSERVER]
        VPNPassword = Friday2014
        VPNServerURL = 54.68.105.194:443

        [SITE0]
        GUID = 9876543210
        name = Marthas Cakes

        [DEVICE0]
        type = switch
        IPAddr = 192.168.1.64

        [DEVICE1]
        type = AP
        IPAddr = 192.168.1.63

        [DEVICE2]
        type = disk
        size = 20.0

    -- create the logDB database
    cd /home/ubuntu/src/ld/mgmtserver/server/db
    python devLog.py
    sudo cp /home/ubuntu/src/ld/mgmtserver/server/db/logDB.json /var/lib/ld/db

    -- generate main sqlite3 DB, then set permissions and ownership
    cd /usr/local/lib/ld/mgmtserver/server/db
    sudo python makeMainDB.py
    sudo chown -R ubuntu:ubuntu /var/lib/ld

    -- set permissions on /var/log and make ubuntu a part of the sudo and syslog groups
    sudo chown root:syslog /var/log
    sudo chmod ug+rwx /var/log
    sudo vi /etc/group
        -- modify:
            sudo:x:27:ubuntu
            syslog:x:104:ubuntu

    -- update init to autostart VPN server, start server, set password, verify all OK
    sudo cp /usr/local/lib/ld/libs/vpn/funcs/vpnserver /etc/init.d
    sudo chmod 755 /etc/init.d/vpnserver
    sudo update-rc.d vpnserver defaults
    sudo /etc/init.d/vpnserver start
    sudo /usr/local/vpnserver/vpncmd localhost:443 /SERVER /CMD ServerPasswordSet Friday2014
    sudo /usr/local/vpnserver/vpncmd localhost:443 /TOOLS /CMD check
    sudo /usr/local/vpnserver/vpncmd localhost:443 /SERVER /PASSWORD:Friday2014 /CMD ServerStatusGet

    -- configure VPN server
    cd /usr/local/lib/ld/libs/vpn/funcs
    sudo /usr/local/vpnserver/vpncmd localhost:443 /SERVER /PASSWORD:Friday2014 /IN:serversetup.bat
    sudo /usr/local/vpnserver/vpncmd localhost:443 /SERVER /PASSWORD:Friday2014 /CMD HubList

    NOTE: to remove the VPN server:
        sudo /etc/init.d/vpnserver stop
        sudo update-rc.d -f vpnserver remove
        sudo rm /etc/init.d/vpnserver
        sudo rm -rf /usr/local/vpnserver

    -- set up temp storage for VPN manager helper functions and copy them over
    sudo mkdir -p /tmp/ram && sudo chmod a+rwx /tmp/ram
    sudo cp /usr/local/lib/ld/libs/vpn/funcs/ld_vpnfuncs.py /usr/local/bin
    sudo chown root:root /usr/local/bin/*
    sudo chmod 0550 /usr/local/bin/*

    -- start off the manager daemon
    sudo supervisorctl
        supervisor> reread
        supervisor> update
        supervisor> status
        supervisor> exit

    -- add the new management server to the regserver DB
    -- ssh to regserver, then:
    cd /home/ubuntu/src/ld/regserver/server/db
    vi regTable.py
    -- modify:
        entryDict = { "deviceName": "Marthas Shop",
                      "authParams": { 'username': 'vcio', 'password': 'whatever' },
                      "mgmtServerURL": "http://54.68.105.194:8080" }
        dw.addOrUpdateRegEntry(GUID='9876543210', entryDict=entryDict)
        print "Created registration DB entry for 'Marthas Shop' GUID '9876543210'"

10. For vcioserver:

    -- ensure django_evolution is installed and everything is up to date
    sudo pip install django_evolution
    cd /home/ubuntu/src/ld/vcioserver/site
    python manage.py syncdb
    python manage.py collectstatic

    -- verify settings.py is all good
    vi /home/ubuntu/src/ld/vcioserver/site/apps/settings.py
        -- review and ensure nothing is out of place
        -- make sure logging goes to the right place

    -- add MYIPADDR to .bashrc
    # set environment variable to indicate IP address of this host, for Django
    MYIPADDR="54.68.66.127"
    export MYIPADDR

    -- create the supervisord config file
    sudo vi /etc/supervisor/conf.d/vcioserver.conf
        -- modify:
        [program:vcioserver]
        command=python -u manage.py runserver 0.0.0.0:8000
        process_name=vcioserver
        directory=/home/ubuntu/src/ld/vcioserver/site
        stdout_logfile=/tmp/vcioConsole.log
        stdout_logfile_backups=3
        stdout_logfile_maxbytes=10MB
        redirect_stderr=true
        autostart=true
        autorestart=true
        startretries=1000
        user=ubuntu

    -- start off the manager daemon
    sudo supervisorctl
        supervisor> reread
        supervisor> update
        supervisor> status
        supervisor> exit
