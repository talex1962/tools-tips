NILFS2 FOR SNAPSHOTTING
-----------------------

1. nilfs-tools must already be installed:

    sudo apt-get install nilfs-tools

    NOTE: reboot after this to get the kernel modules, or run
        sudo modprobe nilfs2

2. Create a volume and format with nilfs2, leaving room for snapshots:
    (NOTE: nilfs2 eats about X% of the raw volume for overhead)

    sudo lvcreate -L 3.5G -n drive storage
    sudo mkfs.nilfs2 /dev/storage/drive
    sudo mount -t nilfs2 /dev/storage/drive /srv/storage/drive

    NOTE: creating nilfs2 is faster than ext4.
    NOTE: add data to the btrfs partition with rsync:
        sudo rsync -azh /srv/storage/testdata/trunk /srv/storage/drive
        -- takes about 6.5 minutes

2. Change an nilfs2 checkpoint into a read-only snapshot:

    sudo lscp /dev/storage/drive
        -- see the checkpoints listed for the drive
    sudo mkcp -s /dev/storage/drive
        -- converts the latest checkpoint into a snapshot
    sudo lscp -s /dev/storage/drive
        -- lists only the snapshots (one created)

3. Mount the selected snapshot on a well-known path:

    sudo lscp -s /dev/storage/drive
        -- get the ID XXX of the snapshot to mount
    sudo mkdir -p /srv/storage/backup/snap1
    sudo mount -t nilfs2 -r -o cp=XXX /dev/storage/drive /srv/storage/backup/snap1
        -- this mounts the snapshot under backup/snap1

4. Mirror the mounted snapshot to the cloud server:

    sudo rsync --delete -azhe 'ssh -q -y -i /root/.ssh/id_rsa' /srv/storage/backup/snap1/ user@cloud-server:/srv/storage/drivebak/data

        where the volume holding the mirror is mounted on /srv/storage/drivebak and
        ./data is the target directory into which the mirror is created

    NOTE: takes about 6min15sec to mirror 2.7 GB this way over a GigE link;
        subsequent invocations of rsync on unchanged data take <5 seconds, and
        an invocation on about 50 MB of modified data takes about 15 seconds.

5. Unmount and delete snapshots that are unwanted:

    sudo umount /srv/storage/backup/snap1
    sudo lscp -s /dev/storage/drive
        -- get the ID XXX of the snapshot to delete
    sudo chcp cp /dev/storage/drive XXX
        -- this changes a snapshot to a checkpoint, to be garbage-collected as usual
        -- process is virtually instantaneous

    NOTE: if desired, remove all checkpoints before and including the newly deleted
        snapshot (after changing the snapshot to a checkpoint), and garbage-collect:
        sudo rmcp -f /dev/storage/drive 1..XXX
        sudo nilfs-clean /dev/storage/drive
        -- process is virtually instantaneous

7. To snapshot the mirror on the remote cloud server, follow the same steps as for rsnapshot
    (if using ext4) or steps 1-4 above (if using nilfs2)
