BTRFS FOR SNAPSHOTTING
----------------------

1. btrfs-tools must already be installed:

    sudo apt-get install btrfs-tools

    NOTE: reboot after this to get the kernel modules.

2. Create a volume and format with btrfs, leaving room for snapshots:
    (NOTE: btrfs eats about 10% of the raw volume for overhead)

    sudo lvcreate -L 3.5G -n drive storage
    sudo mkfs.btrfs /dev/storage/drive
    sudo mount /dev/storage/drive /srv/storage/drive

    NOTE: creating btrfs filesystem takes a few seconds.
    NOTE: add data to the btrfs partition with rsync:
        sudo rsync -azh /srv/storage/testdata/trunk /srv/storage/drive
        -- takes about 6 minutes

2. Make a btrfs read-only snapshot into the .snapshots directory:

    sudo mkdir /srv/storage/drive/.snapshots
    sudo btrfs subvolume snapshot -r /srv/storage/drive/.snapshots/snap1
        -- this creates a snapshot subvolume snap1 in /dev/storage/drive/.snapshots
        -- extremely fast (less than 1 sec)

3. Mount the snapshot on a well-known path:

    sudo btrfs subvolume list -a /srv/storage/drive
        -- get the ID of the snapshot created
    sudo mkdir /srv/storage/backup/snap1
    sudo mount -o subvolid=XXX /dev/storage/drive /srv/storage/backup/snap1
        -- this mounts the snapshot

4. Mirror the mounted snapshot to the cloud server:

    sudo rsync --delete -azhe 'ssh -q -y -i /root/.ssh/id_rsa' /srv/storage/backup/snap1/ user@cloud-server:/srv/storage/drivebak/data

        where the volume holding the mirror is mounted on /srv/storage/drivebak and
        ./data is the target directory into which the mirror is created

    NOTE: takes about 5min45sec to mirror 2.7 GB this way over a GigE link;
        subsequent invocations of rsync on unchanged data take a few seconds, and
        an invocation on about 50 MB of modified data takes about 15 seconds.

5. Unmount and delete snapshots that are unwanted:

    sudo umount /srv/storage/backup/snap1
    sudo btrfs subvolume delete /srv/storage/drive/.snapshots/snap1
        -- takes about 5 seconds to remove a snapshot after about 50 MB changes

7. To snapshot the mirror on the remote cloud server, follow the same steps as for rsnapshot
    (if using ext4) or steps 1-3 above (if using btrfs)
