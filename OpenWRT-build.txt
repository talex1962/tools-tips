Building OpenWRT
----------------

1. Prepare machine

    -- Load Xubuntu 14.04 64-bit
    -- set up files in /etc
    -- mount diskserver/misc on /mnt/misc

    -- get basic stuff and remove unnecessary stuff
    sudo apt-get install -y openssh-server xtitle vim exuberant-ctags git tcpdump dkms screen
    sudo apt-get purge light-locker xscreensaver gnome-screensaver xlock slock
    sudo apt-get purge gstreamer1.0-pulseaudio network-manager catfish screenshot ispell

    -- set up .ssh/authorized_keys, .bashrc and .vimrc as per standard procedures

    NOTE: for Gparted usage, set up xrdp for remote desktop:
    sudo apt-get install -y xrdp
    sudo /etc/init.d/xrdp start

    Now use remote desktop to access the machine. A new screen will be created. Log
    in with standard user credentials.

2. Install prerequisites (assumes Xubuntu 14.04)

    sudo apt-get install -y asciidoc binutils fastjar bzip2 flex gcc util-linux gawk
    sudo apt-get install -y intltool genisoimage patch rsync ruby sdcc
    sudo apt-get install -y libboost1.55-tools-dev libxml-parser-perl libusb-dev
    sudo apt-get install -y bin86 bcc sharutils openjdk-7-jdk
    sudo apt-get install -y build-essential subversion git-core libncurses5-dev zlib1g-dev
    sudo apt-get install -y quilt libssl-dev xsltproc libboost1.55-tools-dev
    sudo apt-get install -y make mercurial bzr ecj cvs unzip
    sudo apt-get install -y python-pip python-dev python-docutils

    sudo apt-get -y update && sudo apt-get -y upgrade

3. Set up directories and download/untar sources

    -- set up separate toolchain, SDK, imagebuilder from diskserver (optional)
    mkdir -p ~/src/openwrt/tools
    cd ~/src/openwrt/tools

    tar xvf /mnt/misc/littledevs/openwrt/openwrt_trunk/OpenWrt-Toolchain-octeon-for-mips64_octeon_64-gcc-4.6-linaro_uClibc-0.9.33.2.tar
    mv OpenWrt-Toolchain-octeon-for-mips64_octeon_64-gcc-4.6-linaro_uClibc-0.9.33.2 Toolchain

    tar xvf /mnt/misc/littledevs/openwrt/openwrt_trunk/OpenWrt-ImageBuilder-octeon-for-linux-x86_64.tar
    mv OpenWrt-ImageBuilder-octeon-for-linux-x86_64 ImageBuilder

    tar xvf /mnt/misc/littledevs/openwrt/openwrt_trunk/OpenWrt-SDK-octeon-for-linux-x86_64-gcc-4.6-linaro_uClibc-0.9.33.2.tar
    mv OpenWrt-SDK-octeon-for-linux-x86_64-gcc-4.6-linaro_uClibc-0.9.33.2 SDK

    -- get the OpenWRT source and included toolchain (trunk)
    mkdir -p ~/src/openwrt
    cd ~/src/openwrt
    git clone git://git.openwrt.org/openwrt.git trunk
    -- this puts the tree under ~/src/openwrt/trunk

    NOTE: for barrier-breaker (14.07):
        git clone git://git.openwrt.org/14.07/openwrt.git bb
        -- this puts the tree under ~/src/openwrt/bb

    NOTE: once the tree has been placed into a directory, DO NOT MOVE IT!
    There are absolute paths hardcoded into the config during the build.

4. Configure OpenWRT and build it

    -- configure OpenWRT and packages
    cd ~/src/openwrt/trunk (or cd ~/src/openwrt/bb)
    vi feeds.conf.default
    ./scripts/feeds update -a
    ./scripts/feeds install -a
    make package/symlinks
        -- NOTE: this pulls down ALL packages, use with care
    make defconfig
    make prereq
    make menuconfig
        NOTE: select the packages to be downloaded and built here
    make kernel_menuconfig
        NOTE: menuconfig overrides some of the kernel_menuconfig stuff, so
        do this later

    -- fix up Perl build if Perl is included in packages
    cd ~/src/openwrt/openwrt/feeds/packages/lang/perl/files
    cp config.sh-mips.in config.sh-mips64.in
    vi config.sh-mips64.in
        -- change the following:
            archname='mips64-linux-uclibc'
            myarchname='mips64-linux-uclibc'
            targetarch='mips64-linux-uclibc'

    -- make the system (about 12 hours to build)
    make defconfig
    make

    NOTE: for debugging make issues:
        make V=s 2>&1 | tee /tmp/build.log

5. Get binary and load it

    -- untar kernel and root image, then follow instructions in OpenWRT-ERLite3.txt
    cd ~/src/openwrt/openwrt/bin/octeon
    tar xvf openwrt-octeon-erlite-sysupgrade.tar

-----------------------------------------------------------------------------------
Build Configs - ERLite3

1. Configure with block devices, USB (EHCI/OHCI), USB storage, EXT4, PCI (normally defaults)
2. Ensure IDE/EIDE is OFF in make menuconfig - these crash the kernel
3. Ensure UHCI HCD and XHCI HCD (USB 3.0) are off in USB support kernel_menuconfig
4. Verify that USB Mass Storage support is enabled in kernel, but nothing else under
   it is checked

Typical config:

1   CONFIG_64BIT=y
2   CONFIG_64BIT_PHYS_ADDR=y
3   CONFIG_ARCH_BINFMT_ELF_RANDOMIZE_PIE=y
4   CONFIG_ARCH_DISCARD_MEMBLOCK=y
5   CONFIG_ARCH_DMA_ADDR_T_64BIT=y
6   CONFIG_ARCH_HAS_ATOMIC64_DEC_IF_POSITIVE=y
7   CONFIG_ARCH_HAVE_CUSTOM_GPIO_H=y
8   CONFIG_ARCH_HIBERNATION_POSSIBLE=y
9   CONFIG_ARCH_PHYS_ADDR_T_64BIT=y
10  CONFIG_ARCH_SPARSEMEM_ENABLE=y
11  CONFIG_ARCH_SUPPORTS_MSI=y
12  CONFIG_ARCH_SUSPEND_POSSIBLE=y
13  CONFIG_ARCH_WANT_COMPAT_IPC_PARSE_VERSION=y
14  CONFIG_ARCH_WANT_IPC_PARSE_VERSION=y
15  CONFIG_ARCH_WANT_OLD_COMPAT_IPC=y
16  # CONFIG_ARPD is not set
17  CONFIG_BINFMT_ELF32=y
18  CONFIG_BLK_DEV_SD=y
19  CONFIG_BLOCK_COMPAT=y
20  # CONFIG_BOOTPARAM_HUNG_TASK_PANIC is not set
21  CONFIG_BOOTPARAM_HUNG_TASK_PANIC_VALUE=0
22  # CONFIG_CAVIUM_CN63XXP1 is not set
23  # CONFIG_CAVIUM_OCTEON_2ND_KERNEL is not set
24  CONFIG_CAVIUM_OCTEON_CVMSEG_SIZE=2
25  CONFIG_CAVIUM_OCTEON_HW_FIX_UNALIGNED=y
26  CONFIG_CAVIUM_OCTEON_LOCK_L2=y
27  CONFIG_CAVIUM_OCTEON_LOCK_L2_EXCEPTION=y
28  CONFIG_CAVIUM_OCTEON_LOCK_L2_INTERRUPT=y
29  CONFIG_CAVIUM_OCTEON_LOCK_L2_LOW_LEVEL_INTERRUPT=y
30  CONFIG_CAVIUM_OCTEON_LOCK_L2_MEMCPY=y
31  CONFIG_CAVIUM_OCTEON_LOCK_L2_TLB=y
32  CONFIG_CAVIUM_OCTEON_REFERENCE_BOARD=y
33  CONFIG_CC_OPTIMIZE_FOR_SIZE=y
34  CONFIG_CEVT_R4K=y
35  CONFIG_CLONE_BACKWARDS=y
36  CONFIG_COMPAT=y
37  CONFIG_COMPAT_BRK=y
38  CONFIG_COMPAT_NETLINK_MESSAGES=y
39  CONFIG_CPU_BIG_ENDIAN=y
40  CONFIG_CPU_CAVIUM_OCTEON=y
41  CONFIG_CPU_GENERIC_DUMP_TLB=y
42  CONFIG_CPU_HAS_PREFETCH=y
43  CONFIG_CPU_HAS_SYNC=y
44  CONFIG_CPU_MIPSR2=y
45  CONFIG_CPU_RMAP=y
46  CONFIG_CPU_SUPPORTS_64BIT_KERNEL=y
47  CONFIG_CPU_SUPPORTS_HIGHMEM=y
48  CONFIG_CPU_SUPPORTS_HUGEPAGES=y
49  CONFIG_CRAMFS=y
50  CONFIG_CRC16=y
51  CONFIG_CRYPTO_CRC32C=y
52  CONFIG_CRYPTO_HASH=y
53  CONFIG_CRYPTO_HASH2=y
54  CONFIG_DEBUG_INFO=y
55  CONFIG_DEBUG_SPINLOCK=y
56  CONFIG_DEFAULT_HUNG_TASK_TIMEOUT=120
57  CONFIG_DETECT_HUNG_TASK=y
58  CONFIG_DEVKMEM=y
59  CONFIG_DMA_COHERENT=y
60  CONFIG_DNOTIFY=y
61  CONFIG_DTC=y
62  CONFIG_EARLY_PRINTK=y
63  CONFIG_EDAC_SUPPORT=y
64  CONFIG_ENABLE_MUST_CHECK=y
65  CONFIG_EXT4_FS=y
66  CONFIG_FAT_FS=y
67  CONFIG_FRAME_WARN=2048
68  CONFIG_FS_MBCACHE=y
69  # CONFIG_FW_LOADER is not set
70  CONFIG_GENERIC_CLOCKEVENTS=y
71  CONFIG_GENERIC_CLOCKEVENTS_BUILD=y
72  CONFIG_GENERIC_CMOS_UPDATE=y
73  CONFIG_GENERIC_IO=y
74  CONFIG_GENERIC_IRQ_SHOW=y
75  CONFIG_GENERIC_PCI_IOMAP=y
76  CONFIG_GENERIC_SMP_IDLE_THREAD=y
77  CONFIG_GPIO_DEVRES=y
78  # CONFIG_HAMRADIO is not set
79  CONFIG_HARDWARE_WATCHPOINTS=y
80  CONFIG_HAS_DMA=y
81  CONFIG_HAS_IOMEM=y
82  CONFIG_HAS_IOPORT=y
83  CONFIG_HAVE_64BIT_ALIGNED_ACCESS=y
84  CONFIG_HAVE_ARCH_JUMP_LABEL=y
85  CONFIG_HAVE_ARCH_KGDB=y
86  CONFIG_HAVE_ARCH_TRANSPARENT_HUGEPAGE=y
87  # CONFIG_HAVE_BOOTMEM_INFO_NODE is not set
88  CONFIG_HAVE_C_RECORDMCOUNT=y
89  CONFIG_HAVE_DEBUG_KMEMLEAK=y
90  CONFIG_HAVE_DMA_API_DEBUG=y
91  CONFIG_HAVE_DMA_ATTRS=y
92  CONFIG_HAVE_DYNAMIC_FTRACE=y
93  CONFIG_HAVE_FTRACE_MCOUNT_RECORD=y
94  CONFIG_HAVE_FUNCTION_GRAPH_TRACER=y
95  CONFIG_HAVE_FUNCTION_TRACER=y
96  CONFIG_HAVE_FUNCTION_TRACE_MCOUNT_TEST=y
97  CONFIG_HAVE_GENERIC_DMA_COHERENT=y
98  CONFIG_HAVE_GENERIC_HARDIRQS=y
NOTE: THIS CAUSES PROBLEMS - 99  CONFIG_HAVE_IDE=y
100 CONFIG_HAVE_MEMBLOCK=y
101 CONFIG_HAVE_MEMBLOCK_NODE_MAP=y
102 CONFIG_HAVE_MEMORY_PRESENT=y
103 CONFIG_HAVE_MOD_ARCH_SPECIFIC=y
104 CONFIG_HAVE_NET_DSA=y
105 CONFIG_HAVE_OPROFILE=y
106 CONFIG_HAVE_PERF_EVENTS=y
107 # CONFIG_HIGH_RES_TIMERS is not set
108 CONFIG_HOLES_IN_ZONE=y
109 # CONFIG_HUGETLBFS is not set
110 CONFIG_HW_HAS_PCI=y
111 CONFIG_HW_RANDOM=y
112 CONFIG_HW_RANDOM_OCTEON=y
113 CONFIG_HZ=250
114 # CONFIG_HZ_100 is not set
115 CONFIG_HZ_250=y
116 CONFIG_HZ_PERIODIC=y
117 CONFIG_INITRAMFS_SOURCE=""
118 CONFIG_IOMMU_HELPER=y
119 CONFIG_IRQCHIP=y
120 CONFIG_IRQ_DOMAIN=y
121 CONFIG_IRQ_FORCED_THREADING=y
122 CONFIG_IRQ_WORK=y
123 CONFIG_JBD2=y
124 CONFIG_KALLSYMS=y
125 CONFIG_KEXEC=y
126 CONFIG_LIBFDT=y
127 CONFIG_MDIO_BOARDINFO=y
128 CONFIG_MDIO_OCTEON=y
129 CONFIG_MIPS=y
130 CONFIG_MIPS32_COMPAT=y
131 CONFIG_MIPS32_N32=y
132 CONFIG_MIPS32_O32=y
133 # CONFIG_MIPS_HUGE_TLB_SUPPORT is not set
134 CONFIG_MIPS_L1_CACHE_SHIFT=7
135 # CONFIG_MIPS_MACHINE is not set
136 CONFIG_MIPS_MT_DISABLED=y
137 CONFIG_MIPS_PGD_C0_CONTEXT=y
138 CONFIG_MODULES_USE_ELF_REL=y
139 CONFIG_MODULES_USE_ELF_RELA=y
140 # CONFIG_MTD_CFI_INTELEXT is not set
141 CONFIG_MTD_CMDLINE_PARTS=y
142 # CONFIG_MTD_COMPLEX_MAPPINGS is not set
143 CONFIG_MTD_OF_PARTS=y
144 CONFIG_MTD_PHYSMAP=y
145 CONFIG_MTD_PHYSMAP_OF=y
146 CONFIG_MUTEX_SPIN_ON_OWNER=y
147 CONFIG_NEED_SG_DMA_LENGTH=y
148 # CONFIG_NETWORK_FILESYSTEMS is not set
149 CONFIG_NLS=y
150 CONFIG_NLS_CODEPAGE_437=y
151 CONFIG_NLS_ISO8859_1=y
152 CONFIG_NO_GENERIC_PCI_IOPORT_MAP=y
153 CONFIG_NR_CPUS=16
154 CONFIG_NR_CPUS_DEFAULT_16=y
155 CONFIG_OCTEON_ETHERNET=y
156 # CONFIG_OCTEON_ILM is not set
157 CONFIG_OCTEON_MGMT_ETHERNET=y
158 CONFIG_OCTEON_USB=y
159 CONFIG_OCTEON_WDT=y
160 CONFIG_OF=y
161 CONFIG_OF_ADDRESS=y
162 CONFIG_OF_DEVICE=y
163 CONFIG_OF_EARLY_FLATTREE=y
164 CONFIG_OF_FLATTREE=y
165 CONFIG_OF_IRQ=y
166 CONFIG_OF_MDIO=y
167 CONFIG_OF_MTD=y
168 CONFIG_OF_NET=y
169 CONFIG_OF_PCI=y
170 CONFIG_OF_PCI_IRQ=y
171 CONFIG_PAGEFLAGS_EXTENDED=y
172 # CONFIG_PARTITION_ADVANCED is not set
173 CONFIG_PCI=y
174 CONFIG_PCI_DOMAINS=y
175 CONFIG_PERF_USE_VMALLOC=y
176 CONFIG_PHYLIB=y
177 CONFIG_PHYS_ADDR_T_64BIT=y
178 CONFIG_POSIX_MQUEUE=y
179 CONFIG_POSIX_MQUEUE_SYSCTL=y
180 # CONFIG_PREEMPT_RCU is not set
181 CONFIG_PROC_PAGE_MONITOR=y
182 CONFIG_RCU_STALL_COMMON=y
183 CONFIG_RELAY=y
184 CONFIG_RFS_ACCEL=y
185 CONFIG_RPS=y
186 CONFIG_SCHED_DEBUG=y
187 CONFIG_SCSI=y
188 CONFIG_SECCOMP=y
189 CONFIG_SMP=y
190 CONFIG_SPARSEMEM=y
191 CONFIG_SPARSEMEM_STATIC=y
192 CONFIG_SPLIT_PTLOCK_CPUS=999999
193 CONFIG_STOP_MACHINE=y
194 CONFIG_SWAP_IO_SPACE=y
195 CONFIG_SWIOTLB=y
196 CONFIG_SYSFS_DEPRECATED=y
197 CONFIG_SYSFS_DEPRECATED_V2=y
198 CONFIG_SYSVIPC_COMPAT=y
199 CONFIG_SYS_HAS_CPU_CAVIUM_OCTEON=y
200 CONFIG_SYS_HAS_EARLY_PRINTK=y
201 CONFIG_SYS_SUPPORTS_64BIT_KERNEL=y
202 CONFIG_SYS_SUPPORTS_ARBIT_HZ=y
203 CONFIG_SYS_SUPPORTS_BIG_ENDIAN=y
204 CONFIG_SYS_SUPPORTS_HOTPLUG_CPU=y
205 CONFIG_SYS_SUPPORTS_HUGETLBFS=y
206 CONFIG_SYS_SUPPORTS_SMP=y
207 CONFIG_TICK_CPU_ACCOUNTING=y
208 CONFIG_TREE_RCU=y
209 CONFIG_UIDGID_CONVERTED=y
210 CONFIG_UNINLINE_SPIN_UNLOCK=y
211 CONFIG_USB=y
212 CONFIG_USB_ARCH_HAS_XHCI=y
213 CONFIG_USB_COMMON=y
214 CONFIG_USB_EHCI_BIG_ENDIAN_MMIO=y
215 # CONFIG_USB_EHCI_HCD is not set
216 CONFIG_USB_STORAGE=y
217 CONFIG_USB_SUPPORT=y
218 # CONFIG_USB_UHCI_HCD is not set
219 CONFIG_USE_GENERIC_SMP_HELPERS=y
220 CONFIG_USE_OF=y
221 CONFIG_VFAT_FS=y
222 # CONFIG_VLAN_8021Q is not set
223 CONFIG_VM_EVENT_COUNTERS=y
224 CONFIG_WEAK_ORDERING=y
225 CONFIG_XPS=y
226 CONFIG_ZLIB_INFLATE=y
227 CONFIG_ZONE_DMA32=y
228 CONFIG_ZONE_DMA_FLAG=0

----------------------
kernel_menuconfig USB Support shows:
       --- USB support                                                               . .
  . .       <*>   Support for Host-side USB                                               . .
  . .       [ ]     USB verbose debug messages                                            . .
  . .       [ ]     USB announce new devices                                              . .
  . .               *** Miscellaneous USB options ***                                     . .
  . .       [*]     Enable USB persist by default                                         . .
  . .       [ ]     Dynamic USB minor allocation                                          . .
  . .       [ ]     Rely on OTG Targeted Peripherals List                                 . .
  . .       [ ]     Disable external hubs                                                 . .
  . .       < >     USB Monitor                                                           . .
  . .       < >     Support WUSB Cable Based Association (CBA)                            . .
  . .               *** USB Host Controller Drivers ***                                   . .
  . .       < >     Cypress C67x00 HCD support                                            . .
  . .       < >     xHCI HCD (USB 3.0) support                                            . .
  . .       <*>     EHCI HCD (USB 2.0) support                                            . .
  . .       [*]     Root Hub Transaction Translators                                      . .
  . .       [*]     Improved Transaction Translator scheduling                            . .
  . .       < >     Generic EHCI driver for a platform device                             . .
  . .       [*]     Octeon on-chip EHCI support                                           . .
  . .       < >     OXU210HP HCD support                                                  . .
  . .       < >     ISP116X HCD support                                                   . .
  . .       < >     ISP 1760 HCD support                                                  . .
  . .       < >     ISP1362 HCD support                                                   . .
  . .       <*>     OHCI HCD support                                                      . .
  . .       [ ]       Generic OHCI driver for a platform device                           . .
  . .       [*]       Octeon on-chip OHCI support                                         . .
  . .       < >     UHCI HCD (most Intel and VIA) support                                 . .
  . .       < >     SL811HS HCD support                                                   . .
  . .       < >     R8A66597 HCD support                                                  . .
  . .               *** USB Device Class drivers ***                                      . .
  . .       < >     USB Modem (CDC ACM) support                                           . .
  . .       < >     USB Printer support                                                   . .
  . .       < >     USB Wireless Device Management support                                . .
  . .       < >     USB Test and Measurement Class support                                . .
  . .               *** NOTE: USB_STORAGE depends on SCSI but BLK_DEV_SD may ***          . .
  . .               *** also be needed; see USB_STORAGE Help for more info ***            . .
  . .       <*>     USB Mass Storage support                                    
... remainder below are unchecked
